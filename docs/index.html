<html>

<head>
  <title>SciGen.js</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body>
  <script src="bundle.js"></script>
  <script src="promisejs/promise.js"></script>
  <script src="pdftex.js"></script>

  Authors (comma-separated, optional):
  <input id="authors" type="text" />
  <button id="compile" style="width: 150px; display: inline-block">Create PDF</button>
  <button id="running" style="width: 150px; display: none"><img src="loading.gif" /></button>
  <button id="open_pdf_btn" style="width: 150px; display: none">Open PDF</button>
  <a href="https://github.com/davidpomerenke/scigen.js/blob/master/LICENSE" target="_blank">License</a>
  <a href="https://github.com/davidpomerenke/scigen.js" target="_blank">Github</a>

  <script>
    var pdf_dataurl = undefined;
    var compile = function (files) {
      var files = scigen(
          /*authors=*/document.getElementById("authors").value
            .split(',')
            .map(l => l.trim()),
          /*bibInLatex=*/true).files

      document.getElementById("compile").style.display = 'none'
      document.getElementById("running").style.display = 'inline-block'

      var pdftex = new PDFTeX();

      pdftex.set_TOTAL_MEMORY(80 * 1024 * 1024).then(function () {
        pdftex.FS_createLazyFile('/', 'IEEEtran.cls', 'IEEEtran.cls', true, true)
        pdftex.FS_createLazyFile('/', 'IEEE.bst', 'IEEE.bst', true, true)
        for (key of Object.keys(files).filter(key => key !== 'paper.tex')) {
          pdftex.FS_createDataFile('/', key, files[key], true, true)
        }

        pdftex.on_stdout = msg => console.log(msg)
        pdftex.on_stderr = msg => console.log(msg)

        var start_time = new Date().getTime();

        pdftex.compile(files['paper.tex']).then(function (pdf_dataurl) {
          var end_time = new Date().getTime();
          console.info("Execution time: " + (end_time - start_time) / 1000 + ' sec');

          if (pdf_dataurl === false) {
            document.getElementById("running").style.display = 'none'
            document.getElementById("compile").style.display = 'inline-block'
            document.getElementById("compile").innerHTML = 'Fail :/ Try again!'
            return;
          }

          document.getElementById("running").style.display = 'none'
          document.getElementById("open_pdf_btn").style.display = 'inline-block'
          document.getElementById("open_pdf_btn").focus();
        });
      });
    }

    document.getElementById("compile").addEventListener("click", function (e) {
      compile();
    });

    document.getElementById("open_pdf_btn").addEventListener("click", function (e) {
      window.open(pdf_dataurl);
      e.preventDefault();
    });

    var pdftex_preload = new PDFTeX("pdftex-worker.js");
    pdftex_preload = undefined;
  </script>
</body>

</html>